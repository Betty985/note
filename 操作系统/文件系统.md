几个索引表就是几级索引

# 外存

所有的计算机应用程序都要存储信息和检索信息对存储有三个基本要求：

- 能够存储大量的信息
- 长期保存信息
- 可以共享信息

## 磁带

- 永久保存大容量数据
- 顺序存取设备：前面的物理块被存取访问之后，才能存取后续的物理块的内容，存取速度较慢，主要用于后备存储，或存储不经常用的信息。

## 光盘

- 光盘容量大，速度快，价格便宜，但一般不可写- 可读写光盘驱动器价格贵，写过程很麻烦
- 光盘的空间结构与磁盘类似

## 磁盘

直接（随机）存取设备，取磁盘上任一物理块的时间不依赖于该物理块所处的位置

## 外存的特点

- 容量大，断电后仍可保存信息，速度较慢，成本较低
- 两部分组成：驱动部分+存储介质
- 种类很多
- 外存空间组织与地址与存取方式非常复杂
- I/O 过程方式非常复杂

## 外存的管理

磁盘为非易失性存储介质，且存储空间大，可以支持大量信息的长期存储。可以把磁盘当作一种大小固定的块的线性序列，并支持如下两种操作：

- 读块
- 写块

存在的问题：

- 如何找到信息？
- 如何防止一个用户读取另一个用户的数据？
- 如何知道哪些块是空闲的？

解决方法：对外存进行抽象——文件。把信息以一种单元，即文件的形式存储在磁盘或其他外部介质上。文件是通过操作系统来管理的，包括：文件的结构，命名，存取，使用，保护和实现方法。操作系统处理文件的部分成为文件系统。

# 文件

## 数据项

- 基本数据项。这是用于描述一个对象的某种属性的字符集，是数据组织中可以命名的最小逻辑数据单位， 即原子数据，又称为数据元素或字段。它的命名往往与其属性一致。例如，用于描述一个学生的基本数据项有： 学号、 姓名、 年龄、 所在班级等。
- 组合数据项。它是由若干个基本数据项组成的，简称组项。例如，经理便是个组项，它由正经理和副经理两个基本项组成。又如，工资也是个组项，它可由基本工资、工龄工资和奖励工资等基本项所组成。

## 记录

记录是一组相关数据项的集合，用于描述一个对象在某方面的属性。一个记录应包含哪些数据项，取决于需要描述对象的哪个方面。而一个对象，由于他所处的环境不同可把他作为不同的对象。

## 文件的定义

文件是数据的一种组织形式，由数据项或记录构成。
构成文件的基本单位可以是信息项（单个字符或字节），也可以是记录。据此，文件可以有两种定义：

- 文件是具有符号名的信息（数据）项的集合。
- 文件是具有符号名的记录的集合。

## 文件分类

文件分类原因

- 文件的分类是为了更好地管理和使用，要科学地分门别类，对不同的文件进行不同的管理。这样，不仅提高了文件的存取速度，对文件的共享和保护也有利
- 一般系统级与用户级要进行不同的管理。例如，一个系统文件工作时要读入内存，放在内存的某一固定区，有较高的保护级别，一般用户不允许进入。而一般用户的用户文件是在另外管辖的可用区有空闲时才能被调入指定的内存用户区。

分类  
按文件性质与用途分类

- 系统文件
- 程序库文件
- 用户文件

按保护级别分类

- 可执行文件
- 只读文件
- 读写文件

按文件流向分类

- 输入文件
- 输出文件
- 输入/输出文件

### UNIX 文件分类

UNIX 将文件分为普通文件、目录文件、特殊文件（设备文件）三类

- 普通文件:包含的是用户的信息，一般为 ASCII 或二进制文件
- 目录文件:管理文件系统的系统文件
- 特殊文件:
  - 字符设备文件：和输入输出有关，用于模仿串行 I/O 设备，例如终端，打印机，网络等
  - 块设备文件：模仿磁盘（譬如/dev/null）

分类的目的：对不同文件进行管理，提高系统效率；提高用户界面友好性

## 文件命名

许多操作系统支持文件名用圆点隔开为两部分，圆点后面的部分称为文件扩展名。文件扩展名通常表示文件的一些信息。（某类程序的专用数据格式等）

## 文件属性

文件属性也被称为元数据，如文件创建的日期、时间、文件大小等。

## 文件操作

使用文件的目的是存储信息并方便以后的检索，系统一般提供如下系统调用。

- create
- delete
- open
- close
- read
- write
- append
- get attributes
- set attributes
- rename

# 文件系统

## 概念

- 系统角度：是对文件存储器的存储空间进行组织、分配、负责文件的存储并对存入的文件实施保护、检索的一组软件的集合。
- 用户角度：实现“按名存取”

## 功能

- 有效分配文件存储器的存储空间。
- 提供一种组织数据的方法。（物理结构+逻辑结构）
- 提供合适的存储方法，以适应各种不同的应用。（譬如，提供顺序存取和直接存取方法）
- 提供一组服务，使用户能处理数据以执行所需要的操作。（包括创建文件，撤销文件、读文件、写文件、传输文件和控制文件的访问权限等）

# 文件组织

## 两种观点

- 用户观点（逻辑结构）：研究的是用户思维中的抽象文件，也叫逻辑文件。其目的是为用户提供一种结构清晰、使用简便的逻辑组织。用户按此去存储、检索和加工处理有关文件信息。
- 实现观点（物理结构）：研究的是存储在物理设备介质上的实际文件，即物理文件。其目的是选择一些性能良好、设备利用率高的物理结构。系统按此和外部设备打交道，控制信息的传输。

## 逻辑结构

- 记录式文件
  有结构文件，在逻辑上被看成是一组连续顺序的记录的集合。
  - 如果记录的长度都相同，则称为定长记录文件
  - 如果记录的长度不等，则称为变长记录文件
- 流式文件
  无结构的文件，是相关的有序字符的集合。文件长度即为所含字符数。不分成记录，而是直接由一串信息组成。流式文件是相关信息的有序集合，或者说是有一定意义的字符流。
  对大量的源程序、可执行文件、库函数等，所采用的就是无结构的文件形式，即流式文件。其长度以字节为单位。对流式文件的访问，则是采用读写指针来指出下一个要访问的字符。可以把流式文件看作是记录式文件的一个特例（即每个记录只含一个字符）。
  在 UNIX 系统中，所有的文件都被看作是流式文件；即使是有结构文件，也被视为流式文件；系统不对文件进行格式处理。
  好处：提供很大的灵活性

## 存取方式

顺序存取：后一次存取总是在前一次存取的基础上进行，所以不必给出具体的存取位置。如磁带、磁盘。  
直接存储（又称随机存取）：用户以任意次序请求某个记录，需指定起始存取位置（如记录号、字符序号）。如磁盘。

## 物理结构

磁盘的结构允许文件系统按三种不同的方法组织文件：

- 连续文件
- 串联文件
- 随机文件

## 连续文件

一个文件的信息存放在若干连续的物理块中。
由一组相邻的物理块组成，是对记录式文件取连续区分配而构成的文件。

- 优点:
  简单，支持顺序存取和随机存取，顺序存取速度快，所需的磁盘寻道次数和寻道 时间最少。
- 缺点
  文件长度一经固定便不易改变，因而不利于文件的增生和扩充。

## 串联文件

在文件映照结构中，系统有一个文件映照图（以磁盘块号为序），图中每个表项用来记录磁盘块号。

- 优点：
  易于修改，适用于顺序存取方式。
- 缺点：
  文件映照图一般较大，通常将其本身作为一个文件保存在磁盘上，需要时再每次送一块到内存中。

## 随机文件

随机文件是实现非连续分配的另一种方案。
有三种形式的随机文件结构：

- 直接地址结构
  直接使用地址进行存取。（用户必须知道每个记录的具体地址，很不方便）
- 计算寻址结构
  记录的关键字经过某种计算处理，转换成相应的地址。
- 索引结构
  将逻辑文件顺序地划分成长度与物理存储块长度相同的逻辑块，然后为每个文件分别建立逻辑块号与物理块号的对照表。

### 索引文件

索引文件的索引项按文件逻辑块号顺序排列，而分配到的物理块号可以是不连续的。
索引文件的存储区中有两个区：索引区和数据区。
索引区存放索引表
数据区存放数据文件本身

- 优点：
  可以直接读取任意记录，而且便于文件的增删。

# 文件存储空间管理

要实现存储空间的管理：记录空闲存储空间，设置相应的数据结构；对存储空间进行分配与回收

- 空闲块表（空白文件目录）
  将所有空闲块记录在一个表中，即空闲块表
- 空闲块链表
  把所有空闲块链成一个链
- 位图法
  用一串二进制位反映磁盘空间中分配使用情况, 每个物理块对应一位, 分配物理块为 1，否则为 0

# 分配策略

对外存的分配有静态策略和动态策略。

- 静态策略
  用户在创建文件命令中说明文件的大小，操作系统一次分配所需要的区域。
  造成外存碎片；用户通常不知道需要多大的文件。
- 动态策略
  建立一个文件时不分配空间，而在以后每次写文件体的信息时，才按照所写信息的数量进行分配。
  适合串联结构和索引结构。

# 文件控制块

文件控制块（FCB）是操作系统为管理文件而设置的数据结构，存放了为管理文件所需的所有有关信息。
文件控制块包含文件名及文件的各种属性。
文件和文件控制块一一对应，而把文件控制块的有序集合称为文件目录。即一个文件控制块就是一个文件目录项。

# 文件目录

把所有的 FCB 组织在一起，就构成了文件目录，即文件控制块的有序集合。
目录项：构成文件目录的项目（目录项就是 FCB）
目录文件：为了实现对文件目录的管理，通常将文件目录以文件的形式保存在外存，这个文件就叫目录文件。  
支持层次目录结构的大多数操作系统在每个目录中有两个特殊的目录项：
“.”指当前目录
“..”指父目录
相对路径：常与工作目录一起使用，所有不从根目录开始的路径都是相对于工作目录的。

## 目录的实现

- 简单目录
  由 FCB 构成的一个一个目录项组成；
  FCB 中存放了和文件相关的所有控制信息
- 以索引节点实现的目录
  文件名，指向索引结点的指针。
  采用索引结点的方式来实现目录，好处是文件目录的目录项长度会缩短很多，可以提高文件检索速度。因为通过文件目录实现对文件的按名存取时，在寻找文件的过程中只需要用到文件名这个信息，而其他信息在寻找文件的时候没有必要。
  如果一个目录中存放了很多个文件，采用传统的以 FCB 构成目录项的方式，那么这个文件目录会非常大，因为每个目录项就特别大

# 文件共享

文件共享: 一个文件被多个用户或程序使用
共享形式：
被多个用户使用，由存取权限控制
多个用户用相同或不同的名字来访问同一文件
目的：节省时间和存储空间

## 基于索引节点的共享

将文件的物理地址和文件属性等信息放在索引结点中，在文件目录中，设文件名及指向索引结点的指针，另外在索引结点中增加链接计数 count,表示共享的用户数删除时必须 count=0，方可。

## 基于符号链的共享

共享某文件时，创建一新文件，并加到用户目录中，该文件仅包含被链接文件的路径名，称该链接方法为符号链接。
该方式中，只有文件才拥有指向其索引结点的指针，其它共享的用户只有该文件的路径名。

优点：方便地链接任一文件（用路径名）
缺点：访问共享文件时开销大（多次读盘，消费盘空间），每一共享文件都要增加一文件名（因路径名各不相同）

# 文件的保护机制

文件的保护是指文件本身不得被未经文件主授权的任何用户存取，而对于授权用户也只能在允许的存取权限内使用文件。主要方式有：

- 存取控制矩阵
- 存取控制表
- 用户权限表
- 口令。用户为自己的每个文件规定一个口令，并附在用户文件目录中。存取文件时必须提供口令，只有当提供的口令与目录中的口令一致时才允许存取。

  - 缺点
    保护级别少，只有允许和不允许。而没有区分读、写、执行等不同权限。
    保密性能差，保护信息存在系统中，有被人（特别是系统程序员）窃取全部口令的危险。
    不易改变存取控制权限。例如，当文件主想要改变口令以拒绝某一曾经使用过他的文件的用户继续使用文件时，必须把新口令通知其他允许使用他的文件的用户。

- 密码。文件写入时进行编码，读出时进行译码。
  由发请求的用户提供一个变元——代码键。利用这个键做为生成一串相继随机数的起始码。编码时加到文件的字节串上，译码时减去这些随机数。
  - 优点：
    - 代码键不存入系统，只有当用户要存取文件时，才需将代码键送进系统，系统程序员无法偷看和篡改别人的文件。
    - 保密性高、存储空间小
  - 缺点：
    必须花费大量时间编码和译码，增加了系统开销

# 磁盘容错技术

容错技术是通过在系统中设置冗余部件来提高系统可靠性的一种技术。
磁盘容错技术则是通过增加冗余的磁盘驱动器、磁盘控制器等，来提高磁盘系统的可靠性，从而构成实际上的稳定存储器系统。

# 文件系统备份

## 物理转储

从磁盘的第 0 块开始，将全部的磁盘块按序输出到磁带上，直到最后一块复制完毕

- 优点
  简单，快速（以磁盘速度运行）
- 缺点
  不能跳过选定目录，也无法增量转储

## 逻辑转储

从一个或几个指定的目录开始，递归地转储至给定基准日期（例如，最近一次增量转储或全量转储日期）后所有改变的全部文件和目录。

- 优点
  容易恢复满足恢复特定文件或目录的请求

# 文件系统备份

形成文件拷贝的方法基本有两种：
一种是周期性的全量转储，
一种是增量转储。

周期性全量转储有如下缺点：
在转储期间，应停止对文件系统进行其他操作，以免造成混乱。因此，全量转储影响系统对文件的操作，因而不应转储正在打开进行写操作的文件。
转储周期长。如果使用磁带，一次转储可能长达几十分钟，因此不能经常进行，一般一周一次。这样，从转储介质上恢复的文件系统可能与被破坏前那一刻的文件系统差别较大。
一旦系统发生故障，文件系统的恢复过程大致如下：

- 从最近一次全量转储中装入全部系统文件，是系统得以重新启动，并在其控制下进行后续的恢复工作。
- 从近到远从增量转储上恢复文件。可能同一文件曾被转储过若干次，但只恢复最近一次转储的副本，其它则被略去。
- 从最近一次全量转储中，恢复没有恢复过的文件。

# 文件系统一致性

- 文件的一致性检查：文件链接计数与文件所属目录数是否一致。
- 块的一致性检查：使用块情况与空闲块是否一致。
  构造两张表，每张表中为每个块设立一个计数器，都初始化为 0；
  第一个表中的计数器跟踪该块在文件中的出现次数，第二个表中的计数器跟踪该块在空闲表或空闲位图中的出现次数。

# 文件系统性能

## 高速缓存

检查全部的读请求，查看在高速缓存中是否有所需要的块。
如果存在，可执行读操作而无需访问磁盘。
如果不在，首先要把它读到高速缓存，再复制到所需要地方，之后，对同一块的请求都通过高速缓存完成。

## 块提前读

在需要用到块之前，试图提前将其写入高速缓存，从而提高命中率。

## 预测错

读取无用的块，可能导致存高速缓存中删除潜在有用块将会占用固定的磁盘带宽
如果有“脏”块的话，还需要将它们写回磁盘，这就占用了更多的磁盘带宽

## 减少磁盘臂运动

把可能顺序访问的块放在一起，最好是在同一柱面上，从而减少磁盘臂的移动次数。
文件访问时间=寻道时间 + 旋转延时 + 传输时间

## 磁盘碎片整理

随着时间的流逝，文件被不断地创建和删除，于是产生了很多碎片，文件和空穴到处都是。
移动文件使它们相邻，并把所有的（至少是大部分的）空闲空间放在一个或多个大的连续的区域内

## 日志文件系统

CPU 的运行速度越来越快，内存容量越来越大，同时磁盘高速缓存也迅速增加，进而，不需要磁盘访问操作，就可能很大一部分读请求。未来多数磁盘访问是写操作。
将整个磁盘结构化为一个日志，每隔一段时间，或者是有特殊需要时，被缓冲在内存中的所有为决的写操作都被放到一个单独的段中，作为在日志末尾的一个临接段写入磁盘。

## 清理线程

周期性地扫描日志进行磁盘压缩。
遍历日志，从后面移走旧的段，然后将有效的数据放入内存等待写入到下一个段中。
